const orders_detail = [
  r(ecommerce_orders.id),
  r(ecommerce_orders.status),
  r(ecommerce_orders.created_at),
  r(ecommerce_orders.discount),
  r(ecommerce_orders.delivery_attempts),
]

const users_detail = [
  r(ecommerce_users.id),
  r(ecommerce_users.full_name),
  r(ecommerce_users.gender),
  r(ecommerce_users.email),
  r(ecommerce_cities.name),
]

const products_detail = [
  r(ecommerce_products.id),
  r(ecommerce_products.name),
  r(ecommerce_products.price),
]

@tag('1️⃣ Trust/Endorsed')
Dataset demo_ecommerce_version_2 {
  label: '[Demo] Ecommerce Official (2025)'
  description: '''
#### 1. Dataset Scope & Capabilities
When users ask questions, structure your answers based on the following boundaries:
**What This Dataset CAN Answer:**
* **Financial Performance:** Gross sales (GMV), actualized sales after discounts/cancellations (NMV), and platform revenue based on commission.
* **Order Lifecycle Health:** Distinction between pre-delivery issues (Cancellations) and post-delivery dissatisfaction (Refunds).
* **Customer Behavior:** User retention (cohort analysis), repurchase rates, and buyer conversion rates.
* **Granular Performance:** Breakdowns by Country, City, Product Category, and Merchant.
**What This Dataset CANNOT Answer:**
* **True Net Profit:** The dataset calculates Platform Revenue but does not track internal operating costs, marketing spend, or cost of goods sold (COGS).
* **Marketing Attribution:** There is no data regarding traffic sources (e.g., "Did this user come from Facebook or Google?").
* **Inventory Levels:** It tracks sales flow, not stock availability.
* **Shipping Logistics:** While it tracks delivery *status*, it does not contain carrier details, shipping costs, or granular tracking events.

#### 2. Quick-Win Analytical Questions
If a user is unsure where to start, suggest these high-impact queries based on the available metrics:
* **For Revenue Health:** "Show me the trend of GMV versus Revenue for the last 3 months. Why is the gap widening?" (Checks impact of discounts/cancellations).
* **For Operational Issues:** "Which Merchants have a Cancellation Rate above 10%?" (Identifies problematic vendors).
* **For Customer Insight:** "What is the retention rate for users who joined in January vs. February?" (measures cohort quality).
* **For Product Strategy:** "Which Product Categories have high GMV but low Delivered Value?" (Identifies high-demand but hard-to-fulfill items).

#### 3. Interaction Guidelines by Metric Group
Guide the user to the right metric based on their intent:
* **Volume Metrics (Total Orders, Delivered Orders):** Use these for capacity planning and logistics questions.
* *Example:* "How many orders do we need to process this week?"
* **Value Metrics (GMV, NMV, Revenue):** Use these for financial reporting. Always clarify the difference between GMV (demand) and Revenue (earnings).
* *Example:* "Our GMV is up, but are we actually making more money (Revenue)?"
* **Ratio Metrics (Cancellation Rate, Refund Rate):** Use these for efficiency and quality control questions.
* *Example:* "Is our new shipping partner improving our delivery success rate?"

#### 4. Interaction Guidelines by User Persona
Tailor your responses based on who is asking:
* **Executive / CEO:**
  * **Focus:** High-level trends, Revenue, and Year-over-Year growth.
  * **Style:** Synthesize data into bottom-line conclusions. Use the `dynamic_metric` feature to switch between GMV and Revenue instantly.
  * **Watch out for:** The 50% commission rate is hardcoded for demos; remind them this is a simulation figure if they ask about margin accuracy.

* **Sales / Category Manager:**
  * **Focus:** Merchant performance, Category breakdowns, and Top-selling products.
  * **Style:** Compare performance rankings. Use `rank` and `percent_of_total` to highlight top contributors.
  * **Key Action:** Drill down into specific Merchants who are driving high `refunded_value`.

* **Data Team / Analyst:**
  * **Focus:** Data integrity, logic validation, and edge cases.
  * **Style:** Be precise about definitions. Refer to specific AQL logic (e.g., "Revenue is calculated as NMV * 0.5").
  * **Key Action:** Validate the `cohort_month` calculation logic and ensure `vendor_access` permissions are filtering correctly.

#### 5. Instruction on Special Features
* **Dynamic Breakdown:** If a user asks "Can I see this by Country?" and then "Can I see this by Status?", remind them they can use the `Breakdown Dimension` filter to toggle views without rebuilding the chart.
* **Drill-Through:** Remind users that every aggregate number (like Total GMV) can be clicked to reveal the underlying list of Order IDs and User Emails for auditing.
'''
  data_source_name: 'demodb'
  models: [
    ecommerce_products,
    ecommerce_merchants,
    ecommerce_countries,
    ecommerce_orders,
    ecommerce_users,
    ecommerce_order_items,
    ecommerce_cities,
    map_categories,
    param_model_demo,
    dim_dates,
    ecommerce_employees,
    // ecommerce_product_images
  ]
  relationships: [
    relationship(ecommerce_order_items.order_id > ecommerce_orders.id, true),
    relationship(ecommerce_orders.user_id > ecommerce_users.id, true),
    relationship(ecommerce_users.city_id > ecommerce_cities.id, true),
    relationship(ecommerce_cities.country_code > ecommerce_countries.code, true),
    relationship(ecommerce_order_items.product_id > ecommerce_products.id, true),
    // relationship(ecommerce_products.id - ecommerce_product_images.product_id, true),
    relationship(ecommerce_products.merchant_id > ecommerce_merchants.id, true),
    relationship(ecommerce_products_map_categories, true),
    relationship(ecommerce_orders_dim_dates, true),
    relationship(ecommerce_users.sign_up_date > dim_dates.date_key, false)
    ,
    relationship(ecommerce_merchants.city_id > ecommerce_cities.id, false)
    ,
    relationship(ecommerce_employees.merchant_id > ecommerce_merchants.id, true)
  ]

  permission vendor_access {
    field: ref('ecommerce_merchants', 'id')
    operator: 'matches_user_attribute'
    value: 'vendor_id'
  }

  permission country_access {
    field: ref('ecommerce_countries', 'code')
    operator: 'matches_user_attribute'
    value: 'country'
  }

  permission city_access {
    field: ref('ecommerce_cities', 'name')
    operator: 'matches_user_attribute'
    value: 'city'
  }

  // permission pii_access {
  //   field: ref('ecommerce_users', 'email_pii')
  //   operator: 'matches_user_attribute'
  //   value: 'pii_access'
  // }

  dimension cohort_month {
    model: ecommerce_users
    label: "Cohort Month"
    type: 'date'
    definition: @aql min(ecommerce_orders.created_at | month()) | dimensionalize(ecommerce_users.id);;
  }

  dimension month_number {
    model: ecommerce_orders
    label: 'Month Number'
    type: 'number'
    definition: @aql date_diff('month', ecommerce_users.cohort_month, (ecommerce_orders.created_at | month())) ;;
  }

  dimension cohort_size {
    model: ecommerce_orders
    label: 'Cohort Size'
    type: 'number'
    definition: @aql count_distinct(ecommerce_orders.user_id) | exact_grains(ecommerce_users.cohort_month) ;;
  }

  dimension total_orders_all_time {
    model: ecommerce_users
    label: 'Total Orders (Users)'
    type: 'number'
    definition: @aql total_orders | dimensionalize(ecommerce_users.id);;
  }

  dimension is_buyer {
    model: ecommerce_users
    label: 'Is Buyer'
    type: 'truefalse'
    definition: @aql ecommerce_users.total_orders_all_time > 0;;
  }

  dimension is_repeated_buyer {
    model: ecommerce_users
    label: 'Is Repeated Buyer'
    type: 'truefalse'
    definition: @aql ecommerce_users.total_orders_all_time > 1;;
  }

  dimension product_performance_analysis {
    model: ecommerce_products
    label: 'Product Performance Analysis'
    type: 'text'
    definition: @aql concat(
      'https://claude.ai/new?q=write+an_analysis+for+',
      ecommerce_products.name,
      '.+The+GMV+for+this+product+is+',
      cast(gmv, 'text'),
      '+and+the+AOV+for+this+product+is+',
      cast(aov, 'text'),
      )
     ;;
  }

  dimension product_image {
    model: ecommerce_product_images
    label: 'Product Image'
    type: 'text'
    definition: @aql concat('<img src="', ecommerce_product_images.url, '" style="text-align:center;height:50px;object-fit:cover" />') ;;
  }

  dimension breakdown_dim {
    label: 'Dynamic Breakdown Dimension'
    description: 'The dimension will be automatically switched among Country, Age Group, Order Status. By default, it will be Country'
    type: 'text'
    model: ecommerce_orders
    definition: @aql case(
        when: 'Country Names' in param_model_demo.dim_selections
        , then: ecommerce_countries.name

        , when: 'Age Demographic' in param_model_demo.dim_selections
        , then: ecommerce_users.age_group

        , when: 'Order Status' in param_model_demo.dim_selections
        , then: ecommerce_orders.status

        , else: ecommerce_countries.name
      ) ;;
  }

  dimension product_count_within_1_month {
    model: map_categories
    label: 'Product Count (Within 1 Month)'
    type: 'number'
    definition: @aql
      dimensionalize(
        ecommerce_order_items
          | filter(ecommerce_orders.created_at matches @(last 1 month))
          | count(ecommerce_products.id)
        , map_categories.category_id
      )
    ;;
  }

  dimension active_category {
    model: map_categories
    label: 'Active Category'
    type: 'text'
    definition: @aql
      case(
        when: map_categories.product_count_within_1_month > 150, then: map_categories.category,
        else: null
      )
    ;;
  }

  metric total_users {
    label: 'Total Users'
    type: 'number'
    description: '''Total count of registered users on the platform.

**Example**: If the platform has 10,000 registered accounts, total_users = 10,000.

**Analytical Questions**:
- How many users signed up this month vs last month?
- What is the user growth rate by country?
- Which age demographic has the most users?

**Recommended Dimensions**: sign_up_date, gender, age_group, city, country
'''
    definition: @aql count(ecommerce_users.id) ;;
  }
  metric total_orders {
    label: "Total Orders"
    type: "number"
    hidden: false
    description: '''Total number of orders placed across the platform, regardless of status (delivered, cancelled, or refunded).

**Example**: If 500 orders were placed today (300 delivered, 150 cancelled, 50 refunded), total_orders = 500.

**Analytical Questions**:
- How many orders are placed per day/week/month?
- Which countries generate the most orders?
- What is the order volume trend over time?

**Recommended Dimensions**: created_at, status, country, city, product category, merchant
'''
    definition: @aql count(ecommerce_orders.id);;
  }

  metric gmv {
    label: "GMV (Gross Merchandise Value)"
    type: "number"
    hidden: false
    description: '''Total value of all orders before any discounts are applied. Includes all order statuses.

**Formula**: SUM(quantity × product_price)

**Example**: If a customer orders 2 items at $50 each and 1 item at $100, GMV = (2 × $50) + (1 × $100) = $200.

**Analytical Questions**:
- What is our total sales volume this quarter?
- Which product categories generate the highest GMV?
- How does GMV compare across different countries?

**Recommended Dimensions**: created_at, product name, category, merchant, country, user gender/age_group
'''
    definition: @aql ecommerce_order_items | sum(ecommerce_order_items.quantity * ecommerce_products.price);;
    format: "[\$\$]#,###0"
  }

  metric total_discount {
    label: "Total Discount"
    type: "number"
    hidden: false
    description: '''Total discount amount applied across all orders. Represents the difference between gross and net merchandise value.

**Formula**: GMV - Revenue

**Example**: If GMV is $10,000 and Revenue is $8,000, total_discount = $2,000.

**Analytical Questions**:
- How much are we discounting by product category?
- Which merchants offer the highest discounts?
- What is the discount trend over time?

**Recommended Dimensions**: created_at, product category, merchant, country
'''
    definition: @aql gmv - revenue;;
    format: "[\$\$]#,###0"
  }

  metric nmv {
    label: "NMV (Net Merchandise Value)"
    type: "number"
    hidden: false
    description: '''Fulfilled order value after discounts, excluding cancelled and refunded orders. This is what customers actually paid for completed transactions.

**Formula**: SUM(quantity × price × (1 - discount)) WHERE status NOT IN ('cancelled', 'refunded')

**Example**: Order with 2 items at $100 each, 10% discount, and delivered → NMV = 2 × $100 × 0.9 = $180. If cancelled, NMV = $0.

**Analytical Questions**:
- What is our actual fulfilled sales value?
- How does NMV compare to GMV (discount impact)?
- Which merchants have the highest NMV?

**Recommended Dimensions**: created_at, product category, merchant, country, city
'''
    definition: @aql (ecommerce_order_items | sum(ecommerce_order_items.quantity * ecommerce_products.price * (1 - ecommerce_orders.discount))) |  where(ecommerce_orders.status not in ['cancelled', 'refunded']);;
    format: "[\$\$]#,###0"
  }

  metric revenue {
    label: "Total Revenue"
    type: "number"
    hidden: false
    description: '''Platform revenue earned from fulfilled orders. Calculated as NMV multiplied by the commission rate (50% as of May 2025).

**Formula**: NMV × revenue_commission (currently 50%)

**Example**: If NMV is $10,000, platform revenue = $10,000 × 0.5 = $5,000.

**Analytical Questions**:
- What is our platform revenue this month?
- Which product categories drive the most revenue?
- How does revenue vary by country or merchant?

**Recommended Dimensions**: created_at, product category, merchant, country, city
'''
    definition: @aql nmv * revenue_commission;;
    format: "[\$\$]#,###0"
  }

  metric aov {
    label: "AOV (Average Order Value)"
    type: "number"
    description: '''Average gross value per order. Higher AOV indicates customers are spending more per transaction.

**Formula**: GMV / Total Orders

**Example**: If GMV is $50,000 from 1,000 orders, AOV = $50,000 / 1,000 = $50.

**Analytical Questions**:
- Are customers spending more per order over time?
- Which customer segments have the highest AOV?
- Do certain product categories drive higher AOV?

**Recommended Dimensions**: created_at, product category, user age_group, gender, country
'''
    hidden: false
    definition: @aql gmv / total_orders;;
    format: "[\$\$]#,###0"
  }
  metric total_orders_across_all {
    label: "Total Orders Across All"
    type: "number"
    hidden: false
    description: '''Total orders ignoring all dimension filters. Used as denominator for calculating percentages and ratios.

**Formula**: total_orders | of_all(ecommerce_orders)

**Example**: When viewing orders by country, this shows the global total (e.g., 10,000) regardless of country filter.

**Analytical Questions**:
- What percentage of total orders does each segment represent?
- How does a specific dimension compare to the overall platform?

**Recommended Dimensions**: Used alongside any dimension to calculate share of total
'''
    definition: @aql total_orders | of_all(ecommerce_orders);;
  }
  metric percent_of_total {
    label: "Percent Of Total Orders"
    type: "number"
    hidden: false
    description: '''Percentage contribution of a segment to total platform orders. Useful for understanding market share.

**Formula**: (total_orders / total_orders_across_all) × 100%

**Example**: If USA has 2,000 orders out of 10,000 total, percent_of_total = 20%.

**Analytical Questions**:
- What share of orders comes from each country?
- Which product category contributes most to order volume?
- How has market share shifted over time?

**Recommended Dimensions**: country, city, product category, merchant, user age_group
'''
    definition: @aql total_orders * 1.0 / total_orders_across_all;;
    format: "#,###0.00%"
  }
  metric total_delivered_orders {
    label: "Total Delivered Orders"
    type: "number"
    hidden: false
    description: '''Count of orders with status 'delivered'. Represents successfully fulfilled transactions.

**Formula**: total_orders WHERE status = 'delivered'

**Example**: If 800 out of 1,000 orders were delivered, total_delivered_orders = 800.

**Analytical Questions**:
- What is our delivery success rate?
- Which regions have the highest delivery completion?
- How does delivery performance trend over time?

**Recommended Dimensions**: created_at, country, city, merchant, product category
'''
    definition: @aql total_orders | where(ecommerce_orders.status is 'delivered');;
  }
  metric total_refunded_orders {
    label: "Total Refunded Orders"
    type: "number"
    hidden: false
    description: '''Count of orders with status 'refunded'. Indicates post-delivery returns or disputes.

**Formula**: total_orders WHERE status = 'refunded'

**Example**: If 50 out of 1,000 orders were refunded, total_refunded_orders = 50.

**Analytical Questions**:
- What is our refund rate?
- Which products have the highest refund rates?
- Are refunds increasing over time?

**Recommended Dimensions**: created_at, product name, category, merchant, country
'''
    definition: @aql total_orders | where(ecommerce_orders.status is 'refunded');;
  }
  metric total_cancelled_orders {
    label: "Total Cancelled Orders"
    type: "number"
    hidden: false
    description: '''Count of orders with status 'cancelled'. Indicates pre-delivery cancellations by customer or system.

**Formula**: total_orders WHERE status = 'cancelled'

**Example**: If 150 out of 1,000 orders were cancelled, total_cancelled_orders = 150.

**Analytical Questions**:
- What is our cancellation rate?
- Which merchants have high cancellation rates?
- Are there patterns in cancellation timing?

**Recommended Dimensions**: created_at, merchant, product category, country, city
'''
    definition: @aql total_orders | where(ecommerce_orders.status is 'cancelled');;
  }

  metric cancelled_order_ratio {
    label: "Cancelled Order Ratio"
    type: "number"
    hidden: false
    description: '''Percentage of orders that were cancelled. Key indicator of order fulfillment health.

**Formula**: (total_cancelled_orders / total_orders) × 100%

**Example**: If 150 orders cancelled out of 1,000 total, cancelled_order_ratio = 15%.

**Analytical Questions**:
- Is our cancellation rate within acceptable thresholds?
- Which merchants need intervention due to high cancellations?
- How does cancellation rate vary by product category?

**Recommended Dimensions**: created_at, merchant, product category, country
'''
    definition: @aql total_cancelled_orders / total_orders;;
    format: "#,###0.00%"
  }

  metric cancelled_value {
    label: "Cancelled Value"
    type: "number"
    hidden: false
    description: '''Total GMV lost due to cancelled orders. Represents potential revenue that was not realized.

**Formula**: GMV WHERE status = 'cancelled'

**Example**: If $20,000 worth of orders were cancelled, cancelled_value = $20,000.

**Analytical Questions**:
- How much revenue are we losing to cancellations?
- Which high-value products have high cancellation rates?
- What is the financial impact of cancellations by merchant?

**Recommended Dimensions**: created_at, product category, merchant, country
'''
    definition: @aql gmv | where(ecommerce_orders.status is 'cancelled');;
    format: "[\$\$]#,###0"
  }

  metric cancelled_value_ratio {
    label: "Cancelled Value Ratio"
    type: "number"
    hidden: false
    description: '''Percentage of GMV lost to cancellations. Measures financial impact of order failures.

**Formula**: (cancelled_value / GMV) × 100%

**Example**: If $20,000 cancelled out of $100,000 GMV, cancelled_value_ratio = 20%.

**Analytical Questions**:
- What percentage of potential revenue is lost to cancellations?
- Are high-value orders more likely to be cancelled?
- Which segments have the worst cancellation value ratios?

**Recommended Dimensions**: created_at, product category, merchant, country
'''
    definition: @aql cancelled_value / gmv;;
    format: "#,###0.00%"
  }

  metric delivered_value {
    label: "Delivered Value"
    type: "number"
    hidden: false
    description: '''Total GMV from successfully delivered orders. Core measure of fulfilled transaction value.

**Formula**: GMV WHERE status = 'delivered'

**Example**: If $80,000 worth of orders were delivered, delivered_value = $80,000.

**Analytical Questions**:
- What is our total fulfilled order value?
- Which products drive the most delivered value?
- How does delivery value trend by region?

**Recommended Dimensions**: created_at, product category, merchant, country, city
'''
    definition: @aql gmv | where(ecommerce_orders.status is 'delivered');;
    format: "[\$\$]#,###0"
  }

  metric refunded_value {
    label: "Refunded Value"
    type: "number"
    hidden: false
    description: '''Total GMV from refunded orders. Indicates post-delivery returns and customer dissatisfaction costs.

**Formula**: GMV WHERE status = 'refunded'

**Example**: If $5,000 worth of orders were refunded, refunded_value = $5,000.

**Analytical Questions**:
- How much revenue is being returned?
- Which products have the highest refund values?
- Are certain merchants generating more refunds?

**Recommended Dimensions**: created_at, product name, category, merchant, country
'''
    definition: @aql gmv | where(ecommerce_orders.status is 'refunded');;
    format: "[\$\$]#,###0"
  }
  metric retention {
    label: 'Cohort Retention'
    type: 'number'
    hidden: false
    description: '''Percentage of users from a cohort who placed an order in a given month. Key metric for understanding customer loyalty.

**Formula**: (users with orders in month N) / (total users in cohort) × 100%

**Example**: If 100 users signed up in Jan and 40 ordered in Feb, Feb retention = 40%.

**Analytical Questions**:
- How well do we retain customers after their first purchase?
- Which cohorts have the best long-term retention?
- At what month do we see the biggest drop-off?

**Recommended Dimensions**: cohort_month, month_number, country, user age_group
'''
    definition: @aql (total_users * 1.0) / (total_users | of_all(ecommerce_orders.month_number)) ;;
    format: "#,###0.00%"
  }
  metric total_buyers {
    label: "Total Buyers"
    type: "number"
    hidden: false
    description: '''Count of unique users who made at least one purchase. Measures conversion from registered user to paying customer.

**Formula**: COUNT(users) WHERE is_buyer = true

**Example**: If 3,000 out of 10,000 users made a purchase, total_buyers = 3,000.

**Analytical Questions**:
- What is our user-to-buyer conversion rate?
- Which demographics convert best to buyers?
- How is buyer acquisition trending over time?

**Recommended Dimensions**: sign_up_date, gender, age_group, country, city
'''
    definition: @aql count(ecommerce_users.id) | where(ecommerce_users.is_buyer is true);;
  }
  metric total_repeated_buyers {
    label: "Total Repeated Buyers"
    type: "number"
    hidden: false
    description: '''Count of users who made more than one purchase. Indicates customer loyalty and repeat purchase behavior.

**Formula**: COUNT(users) WHERE is_repeated_buyer = true (total_orders > 1)

**Example**: If 1,000 out of 3,000 buyers made 2+ purchases, total_repeated_buyers = 1,000.

**Analytical Questions**:
- What is our repeat purchase rate?
- Which products drive repeat purchases?
- Are certain demographics more likely to become repeat buyers?

**Recommended Dimensions**: sign_up_date, gender, age_group, country, product category
'''
    definition: @aql count(ecommerce_users.id) | where(ecommerce_users.is_repeated_buyer is true);;
  }
  metric running_total_orders {
    label: "Running Total Orders"
    type: "number"
    hidden: false
    description: '''Cumulative sum of orders over time. Shows growth trajectory and total volume progression.

**Formula**: running_total(total_orders) by year

**Example**: If Q1=1,000, Q2=1,500, Q3=2,000 orders → running total at Q3 = 4,500.

**Analytical Questions**:
- Are we on track to meet annual order targets?
- How does cumulative growth compare YoY?
- At what point did we hit major milestones?

**Recommended Dimensions**: created_at (year, quarter, month)
'''
    definition: @aql running_total(total_orders, ecommerce_orders.created_at | year());;
  }

  metric dynamic_metric {
    label: 'Dynamic Metric (no format)'
    type: 'number'
    description: '''Parameter-driven metric that switches between different KPIs based on user selection. Values are unformatted.

**Available Options**: total users, total orders, platform revenue, GMV, NMV, AOV

**Example**: Select 'GMV' from parameter → metric displays GMV value.

**Analytical Questions**:
- How do different metrics compare across the same dimensions?
- Build flexible dashboards where users choose their KPI

**Recommended Dimensions**: Any dimension; best used with breakdown_dim for dynamic analysis
'''
    definition: @aql
      case(
        
        when: 'total users' in param_model_demo.metric_selections
        , then: ecommerce_users.total_users

        , when: 'total orders' in param_model_demo.metric_selections
        , then: total_orders

        , when: 'platform revenue' in param_model_demo.metric_selections
        , then: revenue

        , when: 'GMV' in param_model_demo.metric_selections
        , then: gmv

        , when: 'NMV' in param_model_demo.metric_selections
        , then: nmv

        , when: 'AOV' in param_model_demo.metric_selections
        , then: aov

      )
     ;;
  }

  metric dynamic_metric_currency {
    label: 'Dynamic Metric (Currency)'
    type: 'number'
    description: '''Parameter-driven metric for currency-formatted KPIs. Automatically formats values with $$ symbol.

**Available Options**: platform revenue, GMV, NMV, AOV

**Example**: Select 'AOV' from parameter → metric displays formatted AOV (e.g., $$50).

**Analytical Questions**:
- Compare monetary metrics across dimensions with proper formatting
- Build executive dashboards with user-selectable revenue metrics

**Recommended Dimensions**: created_at, country, merchant, product category
'''
    definition: @aql
      case(
        when: 'platform revenue' in param_model_demo.metric_selections_currency
        , then: revenue

        , when: 'GMV' in param_model_demo.metric_selections_currency
        , then: gmv

        , when: 'NMV' in param_model_demo.metric_selections_currency
        , then: nmv

        , when: 'AOV' in param_model_demo.metric_selections_currency
        , then: aov

      )
     ;;
    format: "[\$\$]#,###0"
  }

  metric revenue_commission {
    label: "Revenue Commission Rate (Demo from May 2025)"
    type: "number"
    hidden: false
    description: '''Platform commission rate applied to NMV to calculate revenue. Currently fixed at 50% for demo purposes.

**Formula**: Constant value = 0.5 (50%)

**Example**: revenue = NMV × 0.5. If NMV = $10,000, revenue = $5,000.

**Analytical Questions**:
- What if we changed the commission rate?
- How does commission impact platform profitability?

**Note**: This is a configuration metric. In production, this might vary by merchant tier or product category.
'''
    definition: @aql 0.5;;
    format: "#,###%"
  }


  view {
    // Core Volume Metrics
    group volume_metrics {
      metric total_orders
      metric total_delivered_orders
      metric total_cancelled_orders
      metric total_refunded_orders
      metric running_total_orders
      metric total_orders_across_all
    }

    // User & Customer Metrics
    group user_metrics {
      metric total_users
      metric total_buyers
      metric total_repeated_buyers
      metric retention
    }

    // Revenue & Value Metrics
    group revenue_metrics {
      metric gmv
      metric nmv
      metric revenue
      metric aov
      metric total_discount
      metric revenue_commission
    }

    // Order Value by Status
    group order_value_metrics {
      metric delivered_value
      metric cancelled_value
      metric refunded_value
    }

    // Performance & Ratio Metrics
    group performance_metrics {
      metric percent_of_total
      metric cancelled_order_ratio
      metric cancelled_value_ratio
    }

    model ecommerce_products {
    }

    model ecommerce_merchants {
    }

    model ecommerce_countries {
    }

    model ecommerce_orders {
    }

    model ecommerce_users {
    }

    model ecommerce_order_items {
    }

    model ecommerce_cities {
    }

    model map_categories {
    }

    model dim_dates {
    }

    model ecommerce_employees {
    }
  }

  owner: 'vincent@holistics.io'

  context {
    analysis {
      underlying_data {
        metric total_orders {
          view order_records {
            label: 'Order records'
            fields: orders_detail
          }

          view user_records {
            label: 'User records'
            fields: users_detail
          }

          view product_records {
            label: 'Product records'
            fields: products_detail
          }
        }

        metric gmv {
          view order_records {
            label: 'Order records'
            fields: orders_detail
          }

          view user_records {
            label: 'User records'
            fields: users_detail
          }
        }

        metric aov {
          view order_value_details {
            label: 'Order value details'
            fields: [
              r(ecommerce_order_items.order_id),
              r(ecommerce_order_items.product_id),
              r(ecommerce_order_items.quantity),
              r(ecommerce_products.price),
            ]
          }

          view aov_by_users {
            label: 'AOV by users'
            fields: users_detail
          }
        }
      }

      breakdown {
        group locations {
          label: 'Locations'
          fields: [
            r(ecommerce_countries.continent_name),
            r(ecommerce_countries.name),
            r(ecommerce_cities.name),
          ]
        }

        group product_categories {
          label: 'Product categories'
          fields: [
            r(map_categories.category),
            r(ecommerce_products.name),
          ]
        }

        group user_demographics {
          label: 'User demographics'
          fields: [
            r(ecommerce_users.gender),
            r(ecommerce_users.age),
          ]
        }
      }
    }
  }
}